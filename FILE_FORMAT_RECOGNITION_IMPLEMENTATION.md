# Реализация распознавания форматов файлов с Docling

## Обзор

Данная реализация добавляет поддержку автоматического распознавания и обработки различных форматов файлов в tg-note бота с использованием библиотеки Docling.

## Реализованные возможности

### 1. Поддерживаемые форматы файлов

- **Документы**: PDF, DOCX, PPTX, XLSX
- **Текстовые файлы**: MD, HTML, TXT
- **Изображения**: JPG, JPEG, PNG, TIFF

### 2. Основные компоненты

#### FileProcessor (`src/processor/file_processor.py`)
Новый модуль для обработки файлов с использованием Docling:

- **Инициализация Docling**: Автоматическая проверка доступности библиотеки
- **Определение формата**: Распознавание формата файла по расширению
- **Обработка файлов**: Извлечение текстового содержимого из файлов
- **Интеграция с Telegram**: Скачивание и обработка файлов из Telegram
- **Управление временными файлами**: Автоматическая очистка

Ключевые методы:
```python
- is_available() -> bool
- get_supported_formats() -> list
- detect_file_format(file_path: Path) -> Optional[str]
- process_file(file_path: Path) -> Optional[Dict]
- download_and_process_telegram_file(bot, file_info, original_filename) -> Optional[Dict]
```

#### ContentParser (обновлен `src/processor/content_parser.py`)

Расширен новым методом для обработки файлов:

```python
async def parse_group_with_files(self, group, bot=None) -> Dict
```

Изменения:
- Добавлена инициализация `FileProcessor` в конструкторе
- Новый асинхронный метод `parse_group_with_files()` для обработки файлов
- Интеграция содержимого файлов с текстом сообщений
- Автоматическое добавление метаданных файлов
- Поддержка как документов, так и фотографий

#### BotHandlers (обновлен `src/bot/handlers.py`)

Изменения в обработчиках сообщений:

```python
# В _process_note_creation() и _process_question():
content = await self.content_parser.parse_group_with_files(group, bot=self.bot)
```

Теперь обработчики:
- Используют новый метод для обработки файлов
- Поддерживают асинхронную обработку
- Автоматически извлекают содержимое из прикрепленных файлов

### 3. Зависимости

Добавлена новая зависимость в `pyproject.toml`:

```toml
"docling>=2.0.0"
```

### 4. Тесты

#### Обновлены существующие тесты (`tests/test_content_parser.py`)
- Исправлены вызовы статических методов на методы экземпляра
- Все тесты теперь совместимы с новой инициализацией `ContentParser`

#### Добавлены новые тесты (`tests/test_file_processor.py`)
- Тесты инициализации `FileProcessor`
- Тесты определения форматов файлов
- Тесты обработки несуществующих файлов
- Проверка доступности Docling

### 5. Документация

#### Новая страница документации (`docs_site/user-guide/file-format-recognition.md`)
Включает:
- Обзор возможностей
- Список поддерживаемых форматов
- Примеры использования
- Архитектура системы
- Инструкции по установке
- Примеры обработки различных типов файлов
- Обработка ошибок
- Настройки
- Расширенное использование
- Отладка

#### Обновлен README.md
- Добавлена информация о новой функции в разделе "Key Features"
- Обновлен список поддерживаемых типов контента
- Добавлена ссылка на документацию
- Обновлен Roadmap

#### Обновлен mkdocs.yml
- Добавлена новая страница в навигацию раздела "User Guide"

## Процесс обработки файлов

### Пошаговый процесс

1. **Получение сообщения**: Пользователь отправляет сообщение с прикрепленным файлом
2. **Группировка**: Сообщение добавляется в группу (если есть несколько последовательных сообщений)
3. **Парсинг с файлами**: Вызывается `parse_group_with_files()` с экземпляром бота
4. **Скачивание файла**: `FileProcessor` скачивает файл из Telegram во временную директорию
5. **Обработка Docling**: Docling извлекает текстовое содержимое из файла
6. **Интеграция**: Содержимое файла добавляется к тексту сообщения
7. **Очистка**: Временные файлы автоматически удаляются
8. **Обработка агентом**: Объединенный контент передается AI агенту
9. **Сохранение**: Результат сохраняется в базу знаний

### Схема потока данных

```
Telegram Message (with file)
    ↓
BotHandlers.handle_document_message() / handle_photo_message()
    ↓
ContentParser.parse_group_with_files(group, bot)
    ↓
FileProcessor.download_and_process_telegram_file(bot, file_info)
    ↓
FileProcessor.process_file(temp_file_path)
    ↓
Docling.DocumentConverter.convert(file_path)
    ↓
Extract text content + metadata
    ↓
Append to message text
    ↓
Return to BotHandlers
    ↓
Process with AI Agent
    ↓
Save to Knowledge Base
```

## Особенности реализации

### 1. Асинхронность
- Все операции с файлами выполняются асинхронно
- Не блокирует обработку других сообщений
- Эффективное использование ресурсов

### 2. Обработка ошибок
- Graceful degradation: если Docling недоступен, бот продолжает работать
- Логирование всех ошибок
- Информативные сообщения пользователю
- Автоматическая очистка даже в случае ошибок

### 3. Временные файлы
- Создание уникальных временных директорий
- Автоматическая очистка после обработки
- Обработка исключений при очистке
- Поддержка определения расширения файла из имени или пути

### 4. Метаданные
Для каждого обработанного файла сохраняются:
- Имя файла
- Формат файла
- Размер файла
- Название документа (если доступно)
- Источник документа (если доступно)

### 5. Интеграция с контентом
- Содержимое файлов добавляется к тексту сообщения
- Четкое разделение с помощью маркеров
- Сохранение структуры метаданных
- Пересчет хеша контента с учетом файлов

## Совместимость

### Обратная совместимость
- Существующий метод `parse_group()` остается без изменений
- Старые тесты продолжают работать
- Плавная деградация при отсутствии Docling

### Поддержка различных режимов
- Режим создания заметок: файлы обрабатываются и сохраняются
- Режим вопросов: файлы обрабатываются как контекст для вопросов

## Производительность

### Оптимизации
- Асинхронная обработка файлов
- Временное хранение минимизировано
- Эффективная очистка ресурсов
- Параллельная обработка нескольких файлов в одном сообщении

### Ограничения
- Максимальный размер файла: 20 МБ (ограничение Telegram API для ботов)
- Время обработки зависит от размера и сложности файла
- OCR для изображений может требовать больше времени

## Будущие улучшения

### Запланированные улучшения
1. **Кэширование**: Сохранение обработанных файлов для избежания повторной обработки
2. **Batch processing**: Обработка нескольких файлов параллельно
3. **Поддержка архивов**: Обработка ZIP, TAR.GZ и других архивов
4. **Аудио/Видео**: Транскрипция аудио и видео файлов
5. **Улучшенное извлечение таблиц**: Специальная обработка табличных данных
6. **Прогресс-бар**: Показ прогресса обработки больших файлов

### Возможные оптимизации
1. **Streaming processing**: Потоковая обработка больших файлов
2. **Приоритезация**: Обработка маленьких файлов в первую очередь
3. **Пулы воркеров**: Использование пула процессов для CPU-интенсивных операций
4. **Распределенная обработка**: Использование очередей задач для масштабирования

## Тестирование

### Проверка синтаксиса
```bash
python3 -m py_compile src/processor/file_processor.py
python3 -m py_compile src/processor/content_parser.py
python3 -m py_compile src/bot/handlers.py
```
Все файлы прошли проверку синтаксиса ✅

### Модульные тесты
- `tests/test_content_parser.py` - обновлены все тесты
- `tests/test_file_processor.py` - новые тесты для FileProcessor

### Рекомендуемые тесты
```bash
# Запуск всех тестов
pytest tests/

# Тесты с покрытием
pytest --cov=src --cov-report=html

# Специфические тесты
pytest tests/test_file_processor.py -v
pytest tests/test_content_parser.py -v
```

## Установка и использование

### Установка зависимостей
```bash
# С Poetry
poetry install

# С pip
pip install -r requirements.txt
```

### Проверка установки Docling
```python
from src.processor.file_processor import FileProcessor

processor = FileProcessor()
print(f"Docling доступен: {processor.is_available()}")
print(f"Поддерживаемые форматы: {processor.get_supported_formats()}")
```

### Использование
1. Запустите бота: `python main.py`
2. Отправьте файл боту в Telegram
3. Бот автоматически:
   - Определит формат файла
   - Скачает и обработает его
   - Извлечет текстовое содержимое
   - Проанализирует с помощью AI агента
   - Сохранит в базу знаний

## Заключение

Реализация добавляет мощную функциональность распознавания форматов файлов в tg-note бота, делая его более универсальным инструментом для создания базы знаний. Система разработана с учетом:

- ✅ Расширяемости (легко добавить новые форматы)
- ✅ Надежности (обработка ошибок и graceful degradation)
- ✅ Производительности (асинхронная обработка)
- ✅ Удобства использования (автоматическая обработка)
- ✅ Поддерживаемости (чистый код и тесты)

Все изменения полностью совместимы с существующим функционалом и готовы к использованию в продакшене.

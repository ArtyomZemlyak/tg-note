# Qwen Code CLI Agent

Complete guide to using the Qwen Code CLI agent.

---

## Overview

The Qwen Code CLI agent is the most capable option, using the official [qwen-code](https://github.com/QwenLM/qwen-code) CLI for advanced AI processing.

---

## Features

- ✅ Full integration with Qwen3-Coder models
- ✅ Automatic TODO planning
- ✅ Built-in tools: web search, git, github, shell
- ✅ **MCP integration**: automatic access to Docling document processing (PDF, DOCX, images, OCR)
- ✅ Free tier: 2000 requests/day
- ✅ Vision model support
- ✅ CLI execution tracing for debugging — [details →](qwen-cli-debug-trace.md)

---

## Installation

### 1. Install Node.js 20+

```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# macOS
brew install node@20

# Windows
# Download from nodejs.org
```

### 2. Install Qwen Code CLI

```bash
npm install -g @qwen-code/qwen-code@latest
```

Docker: the bot image already includes Node.js 20 and the Qwen CLI. You only need to authenticate inside the running container once (persisted via `~/.qwen` bind mount):

```bash
docker exec -it tg-note-bot bash -lc "qwen"
```

### 3. Verify installation

```bash
qwen --version
```

### 4. Authenticate

```bash
qwen
```

Follow the prompts to authenticate via qwen.ai.

### 5. Configure approval mode (IMPORTANT)

**Critical:** To work with the bot, the CLI must auto-approve tool calls:

```bash
qwen
/approval-mode yolo --project
```

Docker one-liner for non-interactive use:

```bash
docker exec -it tg-note-bot bash -lc "qwen <<<'/approval-mode yolo --project'"
```

**Why this matters**
- By default the CLI asks for manual approval on each action
- The bot runs autonomously and cannot interactively confirm
- `yolo` mode auto-approves all operations from the agent

**⚠️ Warning:** `yolo` grants full access to file ops and commands. Use at your own risk.

**Approval modes:**
- `plan` — analysis only, no file changes
- `default` — asks for confirmation on edits/commands
- `auto-edit` — auto-approves file edits
- `yolo` — auto-approves everything (required for the bot)

**Scopes:**
- `--session` — current session only
- `--project` — current project (recommended)
- `--user` — all projects for the user

See the [official qwen-code-cli docs](https://github.com/QwenLM/qwen-code) for details.

---

## Configuration

Update `config.yaml`:

```yaml
AGENT_TYPE: "qwen_code_cli"
AGENT_QWEN_CLI_PATH: "qwen"
AGENT_TIMEOUT: 300
AGENT_ENABLE_WEB_SEARCH: true
AGENT_ENABLE_GIT: true
AGENT_ENABLE_GITHUB: true
AGENT_ENABLE_SHELL: false
```

Tip: `AGENT_QWEN_CLI_PATH` defaults to `qwen`. Ensure `qwen --version` works before enabling this agent.

### MCP integration

The Qwen CLI auto-discovers MCP servers configured in `~/.qwen/settings.json`. This file is generated by the MCP Hub on startup.

**Available MCP tools:**

- **Docling MCP:** document processing (PDF, DOCX, images, OCR)
  - Auto-configured when Docling is enabled
  - Accessible via `convert_document_from_content`
  - Supports base64 transfer (no shared FS needed)

- **MCP Hub:** built-in memory tools and registry
  - `store_memory`, `retrieve_memory`, `list_categories`
  - Per-user storage isolation

**Configuration location:**

Generated automatically in `~/.qwen/settings.json` by the MCP Hub. In Docker, it is persisted via the `~/.qwen` bind mount.

**Example MCP configuration:**

```json
{
  "mcpServers": {
    "mcp-hub": {
      "url": "http://mcp-hub:8765/sse",
      "timeout": 99999,
      "trust": true
    },
    "docling": {
      "url": "http://docling-mcp:8077/sse",
      "timeout": 99999,
      "trust": true
    }
  },
  "allowMCPServers": ["mcp-hub", "docling"]
}
```

**How it works:**

1. MCP Hub starts and generates `~/.qwen/settings.json`
2. Qwen CLI reads the config on startup
3. CLI connects to configured MCP servers
4. All MCP tools become available in CLI sessions

See also [MCP Architecture](../architecture/mcp-architecture.md) and [File Format Recognition](../user-guide/file-format-recognition.md).

---

## How it works (execution flow)

1. Message received
2. Agent prepares prompt
3. CLI working directory is set to the user's KB path
4. Calls `qwen` CLI in that directory
5. Qwen creates a TODO plan
6. Executes the plan with tools (files created in the KB path)
7. Returns structured markdown
8. Saved to KB

**Important:** CLI runs inside `knowledge_bases/<kb-name>/` so files land in the correct KB.

### Source citations

**Requirement (v4+):** The Qwen CLI agent must include source references in created documents:

- **Inline citations** — links next to facts/concepts
  - Format: `According to [source name](URL), ...`
  - Example: `GPT-4 uses a transformer architecture ([OpenAI Technical Report](https://openai.com/research/gpt-4))`

- **"Sources" section** — mandatory at the end of EVERY created file
  - Format:
    ```markdown
    ## Sources

    1. [Source name](URL) - short description
    2. [Another source](URL) - short description
    ```

- If no sources are available, explicitly note that (but try to cite whenever possible).

---

## Troubleshooting

### CLI not found
- Ensure Node.js 20+ is installed
- Ensure `npm install -g @qwen-code/qwen-code@latest` completed
- Verify `qwen --version`

### Approval mode not applied
- Re-run `/approval-mode yolo --project`
- In Docker, ensure `~/.qwen` is mounted to persist settings

### MCP tools missing
- Check `~/.qwen/settings.json` contains `mcp-hub` and `docling`
- Ensure MCP Hub is running and reachable

### Requests per day exhausted
- Free tier allows ~2000/day; wait/reset or upgrade your plan

---

## AICODE-NOTE
- Use `yolo --project` approval for unattended bot use.
- CLI runs inside the KB directory to keep files organized.
- MCP config is generated automatically; keep the `~/.qwen` mount persistent in Docker.

# Краткая Справка по Логированию Memory Services

## Что Было Сделано

### ✅ Добавлено Полное Логирование

1. **Memory MCP Server** (stdio и HTTP режимы)
   - Все операции логируются в файлы
   - Отдельные логи для ошибок
   
2. **Mem-Agent** (LLM-based память)
   - Логирование работы агента
   - Логирование выполнения Python кода (sandbox)
   - Логирование MCP server операций

3. **vLLM Server** (для mem-agent)
   - Логирование запуска и работы
   - Отдельные логи ошибок

### ✅ Исправлена Проблема с Mem-Agent Режимом

**Проблема:** Memory MCP HTTP сервер не поддерживал mem-agent режим хранения.

**Решение:** Добавлена поддержка `MEM_AGENT_STORAGE_TYPE` environment variable в `memory_server_http.py`.

## Где Находятся Логи

Все логи в директории `logs/`:

```
logs/
├── memory_mcp.log              # Memory MCP (stdio)
├── memory_mcp_errors.log       # Memory MCP ошибки
├── memory_http.log             # Memory HTTP server
├── memory_http_errors.log      # Memory HTTP ошибки
├── mem_agent.log               # Mem-agent
├── mem_agent_errors.log        # Mem-agent ошибки
├── mem_agent_sandbox.log       # Выполнение кода
├── mem_agent_sandbox_errors.log # Ошибки выполнения кода
├── mem_agent_mcp_server.log    # MCP server для mem-agent
├── mem_agent_mcp_server_errors.log # MCP server ошибки
├── vllm_server.log             # vLLM сервер (Linux)
├── vllm_server_errors.log      # vLLM ошибки
├── mlx_server.log              # MLX сервер (macOS)
└── mlx_server_errors.log       # MLX ошибки
```

## Как Использовать Mem-Agent Режим

1. **Установите переменные окружения:**
   ```bash
   export MEM_AGENT_STORAGE_TYPE="mem-agent"
   export MEM_AGENT_MODEL="driaforall/mem-agent"
   export MEM_AGENT_BACKEND="vllm"  # или "auto", "mlx", "transformers"
   ```

2. **Запустите Memory HTTP server:**
   ```bash
   python -m src.agents.mcp.memory.memory_server_http
   ```

3. **Проверьте логи:**
   ```bash
   tail -f logs/memory_http.log
   ```

## Диагностика Проблем

### Если qwen CLI видит тулзы, но они не работают:

1. **Смотрите логи в реальном времени:**
   ```bash
   tail -f logs/memory_http.log
   tail -f logs/mem_agent.log
   ```

2. **Проверьте ошибки:**
   ```bash
   tail -f logs/memory_http_errors.log
   tail -f logs/mem_agent_errors.log
   ```

3. **Проверьте тип storage:**
   ```bash
   grep "Storage type" logs/memory_http.log
   ```

4. **Проверьте вызовы инструментов:**
   ```bash
   grep "store_memory called" logs/memory_http.log
   grep "retrieve_memory called" logs/memory_http.log
   ```

### Если vLLM server не запускается:

```bash
tail -f logs/vllm_server_errors.log
```

### Включить DEBUG режим:

```bash
python -m src.agents.mcp.memory.memory_server_http --log-level DEBUG
```

## Особенности Логирования

- **Автоматическая ротация:** При достижении 10 MB
- **Хранение:** 7 дней (общие), 30 дней (ошибки)
- **Сжатие:** Старые логи автоматически сжимаются в zip
- **Полная трассировка:** Включены backtrace и diagnose

## Что Делать Если Проблемы

1. **Сначала проверьте логи ошибок** - они в файлах `*_errors.log`
2. **Включите DEBUG режим** для детальной диагностики
3. **Проверьте environment variables** - особенно `MEM_AGENT_STORAGE_TYPE`
4. **Убедитесь, что сервер запущен** - смотрите в `memory_http.log`

## Пример Проблемы и Решения

**Проблема:** qwen CLI видит `store_memory` и `retrieve_memory`, но при вызове ошибка.

**Решение:**
1. Смотрим `logs/memory_http.log`:
   ```bash
   tail -100 logs/memory_http.log | grep "called"
   ```
   
2. Смотрим ошибки:
   ```bash
   tail -100 logs/memory_http_errors.log
   ```

3. В логах будет точное описание ошибки с полной трассировкой.

## Тестирование

Быстрая проверка что всё работает:

```bash
# Запустите сервер в одном терминале
export MEM_AGENT_STORAGE_TYPE="mem-agent"
python -m src.agents.mcp.memory.memory_server_http --log-level DEBUG

# В другом терминале смотрите логи
tail -f logs/memory_http.log
```

Должны увидеть:
```
INFO - Initializing memory storage...
INFO - Storage initialized successfully: MemAgentStorage
INFO - Starting memory HTTP MCP server
INFO - Server listening on http://127.0.0.1:8765/sse
```

## Все Готово! 

Теперь при любых ошибках в memory services вы увидите детальную информацию в логах.

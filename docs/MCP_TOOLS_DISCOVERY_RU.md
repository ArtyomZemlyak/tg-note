# Обнаружение MCP Инструментов для Агентов

## Обзор

Этот документ описывает, как агенты обнаруживают и узнают о доступных MCP (Model Context Protocol) инструментах.

## Проблема

Ранее, хотя система могла динамически обнаруживать и регистрировать MCP инструменты во время выполнения, сама LLM не знала об этих инструментах. Это означало:

- **AutonomousAgent**: LLM не получала информацию о доступных MCP инструментах в system prompt
- **QwenCodeCLIAgent**: qwen CLI вообще не получал информацию о MCP инструментах

## Решение

Мы реализовали комплексное решение, которое гарантирует, что все агенты знают о доступных MCP инструментах:

### 1. Генератор Описаний MCP Инструментов

**Файл**: `src/agents/mcp/tools_description.py`

Этот модуль предоставляет функции для генерации человекочитаемых описаний доступных MCP серверов и их инструментов:

- `get_mcp_tools_description(user_id, servers_dir)`: Обнаруживает MCP серверы, подключается к ним и генерирует форматированное описание
- `format_mcp_tools_for_prompt(tools_description, include_in_system)`: Форматирует описание для включения в промпты LLM

**Возможности**:
- Обнаруживает как общие, так и пользовательские MCP серверы
- Подключается к включенным серверам
- Запрашивает у каждого сервера доступные инструменты
- Генерирует подробные описания, включая:
  - Имена инструментов (в формате агента: `mcp_server_tool`)
  - Описания инструментов
  - Схемы параметров
  - Обязательные и опциональные параметры

### 2. Интеграция с AutonomousAgent

**Файл**: `src/agents/autonomous_agent.py`

**Изменения**:
- Добавлен атрибут кэша `_mcp_tools_description`
- Добавлен метод `get_mcp_tools_description()`, который:
  - Возвращает закешированное описание, если доступно
  - Генерирует только если MCP включен
  - Кэширует результат для производительности
- Изменен `_make_decision_llm()` для включения информации о MCP инструментах в system prompt

**Как это работает**:
```python
# Получить описание MCP инструментов
mcp_description = await self.get_mcp_tools_description()

# Добавить в system prompt
system_content = self.instruction
if mcp_description:
    system_content = f"{self.instruction}\n\n{mcp_description}"
```

### 3. Интеграция с QwenCodeCLIAgent

**Файл**: `src/agents/qwen_code_cli_agent.py`

**Изменения**:
- Добавлены атрибуты поддержки MCP: `enable_mcp`, `user_id`, `_mcp_tools_description`
- Добавлен метод `get_mcp_tools_description()` (аналогично AutonomousAgent)
- Добавлен метод `_prepare_prompt_async()`, который включает MCP инструменты в промпт
- Изменен `process()` для использования асинхронной подготовки промпта

**Как это работает**:
```python
# Подготовить базовый промпт
base_prompt = CONTENT_PROCESSING_PROMPT_TEMPLATE.format(...)

# Добавить описание MCP инструментов
mcp_description = await self.get_mcp_tools_description()
if mcp_description:
    return f"{base_prompt}{mcp_description}"
```

## Использование

### Для AutonomousAgent

Когда `AGENT_ENABLE_MCP=true`, LLM агента автоматически получит:

```
## Доступные MCP Инструменты

У вас есть доступ к дополнительным инструментам через MCP (Model Context Protocol):

# Доступные MCP Инструменты

Следующие MCP (Model Context Protocol) серверы доступны со своими инструментами:

## MCP Сервер: mem-agent

### mcp_mem_agent_store_memory
- **Оригинальное имя**: `store_memory`
- **Описание**: Сохранить информацию в памяти
- **Параметры**:
  - `content` (string) (обязательный): Контент для сохранения
  - `category` (string) (опциональный): Категория памяти

...

Используйте эти инструменты когда это подходит для задачи.
```

### Для QwenCodeCLIAgent

Когда `AGENT_ENABLE_MCP=true`, qwen CLI получит ту же информацию в своем входном промпте (отформатированную для пользовательского контекста, а не системного).

## Конфигурация

Включите обнаружение MCP инструментов, установив в `.env` или config:

```bash
# Включить поддержку MCP
AGENT_ENABLE_MCP=true
```

Система будет:
1. Обнаруживать MCP серверы из `data/mcp_servers/` (общие) и `data/mcp_servers/user_{user_id}/` (пользовательские)
2. Подключаться к включенным серверам
3. Запрашивать доступные инструменты
4. Генерировать описания
5. Включать в промпты агентов

## Преимущества

✅ **LLM знают о MCP инструментах**: Инструменты описаны в промптах  
✅ **Автоматическое обнаружение**: Не требуется ручная конфигурация  
✅ **Поддержка пользователей**: Разные пользователи могут иметь разные MCP инструменты  
✅ **Производительность**: Описания кэшируются  
✅ **Подробная информация**: Инструменты включают схемы параметров  
✅ **Работает для всех агентов**: И AutonomousAgent, и QwenCodeCLIAgent  

## Тестирование

Тесты предоставлены в `tests/test_mcp_tools_description.py`:

- `TestMCPToolsDescription`: Тесты генерации описаний
- `TestAutonomousAgentMCPIntegration`: Тесты интеграции AutonomousAgent
- `TestQwenCodeCLIAgentMCPIntegration`: Тесты интеграции QwenCodeCLIAgent

Запуск тестов:
```bash
pytest tests/test_mcp_tools_description.py -v
```

## Детали Реализации

### Кэширование

Оба агента кэшируют описания MCP инструментов, чтобы избежать повторного обнаружения:
- Первый вызов: Обнаруживает серверы, подключается, генерирует описание
- Последующие вызовы: Возвращает закешированное описание
- Кэш хранится для каждого экземпляра агента

### Асинхронная Поддержка

Все MCP операции асинхронные:
- `get_mcp_tools_description()` асинхронная
- `_prepare_prompt_async()` асинхронная для QwenCodeCLIAgent
- Совместима с асинхронной архитектурой агента

### Обработка Ошибок

- Если обнаружение MCP не удается, возвращается пустая строка (плавная деградация)
- Ошибки логируются, но не прерывают выполнение агента
- Если MCP отключен, сразу возвращается пустая строка

## Пример Вывода

Когда у агента включены MCP инструменты, LLM получает:

```markdown
# Доступные MCP Инструменты

Следующие MCP (Model Context Protocol) серверы доступны со своими инструментами:

## MCP Сервер: filesystem

### mcp_filesystem_read_file
- **Оригинальное имя**: `read_file`
- **Описание**: Прочитать содержимое файла
- **Параметры**:
  - `path` (string) (обязательный): Путь к файлу для чтения

### mcp_filesystem_write_file
- **Оригинальное имя**: `write_file`
- **Описание**: Записать содержимое в файл
- **Параметры**:
  - `path` (string) (обязательный): Путь к файлу для записи
  - `content` (string) (обязательный): Контент для записи

---

**Всего доступных MCP инструментов**: 2 от 1 сервера(ов)

**Использование**: Вызывайте эти инструменты используя их имя в агенте (например, `mcp_filesystem_read_file`)
```

## Будущие Улучшения

Потенциальные улучшения:

1. **Фильтрация инструментов**: Позволить агентам указывать, какие MCP инструменты им нужны
2. **Динамическое обновление**: Обновлять описания MCP инструментов при изменении серверов
3. **Расширенные описания**: Включать примеры использования в описания инструментов
4. **Категории инструментов**: Группировать инструменты по категориям или типу сервера
5. **Система разрешений**: Контролировать, какие пользователи имеют доступ к каким MCP инструментам

## Файлы Изменений

### Новые файлы:
- `src/agents/mcp/tools_description.py` - Генератор описаний MCP инструментов
- `tests/test_mcp_tools_description.py` - Тесты
- `docs/MCP_TOOLS_DISCOVERY.md` - Документация (EN)
- `docs/MCP_TOOLS_DISCOVERY_RU.md` - Документация (RU)

### Измененные файлы:
- `src/agents/mcp/__init__.py` - Экспорт новых функций
- `src/agents/autonomous_agent.py` - Интеграция MCP описаний
- `src/agents/qwen_code_cli_agent.py` - Интеграция MCP описаний
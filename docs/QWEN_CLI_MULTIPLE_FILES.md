# Работа с множественными файлами в qwen-code CLI агенте

## ⚠️ Статус: Planned Feature (В разработке)

> **Важно:** Эта документация описывает планируемый функционал, который **еще не полностью реализован**.
> 
> **Текущее состояние:**
> - ✅ Инфраструктура готова (handlers, KB manager, git, tracker)
> - ✅ Telegram бот поддерживает множественные файлы
> - ❌ Агенты пока возвращают только один файл
> - ❌ Разбиение по темам не реализовано
> 
> **Текущее поведение:** Агент создает ОДИН файл со всей информацией из сообщения.

## Обзор

qwen-code CLI агент **планируется** настроить для **разбиения информации по темам** и создания **множественных файлов** из одного сообщения.

## Ключевая возможность (Planned)

**Один источник → Несколько файлов по темам** (в разработке)

Агент **будет** анализировать входящую информацию и:
1. Определять затронутые темы
2. Разбивать информацию по темам
3. Создавать отдельный файл для каждой темы
4. Создавать папки для организации
5. Связывать файлы между собой

## Примеры разбиения

### Пример 1: Статья о модели с vision capabilities

**Входящее сообщение:**
```
Статья: GPT-4 Vision - новая мультимодальная модель от OpenAI
с поддержкой анализа изображений. Модель показывает отличные
результаты в задачах медицинской диагностики.
```

**Что делает агент:**

```
Анализ → 3 темы:
1. Модель GPT-4
2. Мультимодальность/Vision
3. Применение в медицине

Создание структуры:
1. folder_create("ai/models")
2. folder_create("ai/multimodal")
3. folder_create("applications/medical")

Создание файлов:
4. file_create("ai/models/gpt4.md")
   - Основная информация о GPT-4
   - История развития
   - Технические характеристики

5. file_create("ai/multimodal/vision-models.md")
   - Vision capabilities
   - Мультимодальные возможности
   - Обработка изображений

6. file_create("applications/medical/ai-diagnostics.md")
   - Применение AI в медицине
   - GPT-4 для диагностики
   - Кейсы использования

Связывание:
7. file_edit("ai/models/gpt4.md")
   Добавить:
   ## Связанные темы
   - [[ai/multimodal/vision-models.md]] - Vision возможности
   - [[applications/medical/ai-diagnostics.md]] - Применение в медицине

8. file_edit("ai/multimodal/vision-models.md")
   Добавить:
   ## Связанные темы
   - [[ai/models/gpt4.md]] - GPT-4 модель

9. file_edit("applications/medical/ai-diagnostics.md")
   Добавить:
   ## Связанные темы
   - [[ai/models/gpt4.md]] - Используемая модель
```

### Пример 2: Новость о компании и её продукте

**Входящее сообщение:**
```
Anthropic выпустила Claude 3, новую серию моделей с улучшенным
reasoning и поддержкой контекста 200K токенов.
```

**Что делает агент:**

```
Анализ → 2 темы:
1. Компания Anthropic
2. Модели Claude 3

Структура:
1. folder_create("companies")
2. folder_create("ai/models")

Файлы:
3. file_create("companies/anthropic.md")
   - История компании
   - Команда и основатели
   - Продукты
   - Миссия и ценности

4. file_create("ai/models/claude-3.md")
   - Версии (Opus, Sonnet, Haiku)
   - Технические характеристики
   - Возможности
   - Сравнение с другими моделями

Связи:
5. file_edit("companies/anthropic.md")
   ## Продукты
   - [[ai/models/claude-3.md]] - Последняя серия моделей

6. file_edit("ai/models/claude-3.md")
   ## Разработчик
   - [[companies/anthropic.md]] - Anthropic
```

### Пример 3: Технический фреймворк

**Входящее сообщение:**
```
LangChain - фреймворк для создания LLM приложений.
Поддерживает агентов, RAG, tool calling.
Интегрируется с векторными БД.
```

**Что делает агент:**

```
Анализ → 4 темы:
1. LangChain фреймворк
2. AI агенты
3. RAG (Retrieval-Augmented Generation)
4. Векторные базы данных

Структура:
1. folder_create("tech/frameworks")
2. folder_create("ai/agents")
3. folder_create("ai/rag")
4. folder_create("tech/databases")

Файлы:
5. file_create("tech/frameworks/langchain.md")
   - Обзор фреймворка
   - Установка
   - Основные компоненты
   - Примеры использования

6. file_create("ai/agents/langchain-agents.md")
   - Агенты в LangChain
   - Типы агентов
   - Tool calling
   - Примеры

7. file_create("ai/rag/rag-concepts.md")
   - Что такое RAG
   - Как работает
   - Применение в LangChain
   - Best practices

8. file_create("tech/databases/vector-databases.md")
   - Векторные БД
   - Интеграция с LangChain
   - Примеры (Pinecone, Weaviate, Chroma)

Связи:
9. file_edit для каждого файла - добавить связи
```

## Формат файлов

Каждый созданный файл имеет структуру:

```markdown
# Название темы

## Описание
Краткое описание темы (2-3 предложения)

## Основная информация
Детальная информация, структурированно:
- Подтема 1
- Подтема 2
- ...

## Ключевые концепции
- Концепция 1: описание
- Концепция 2: описание
- Концепция 3: описание

## Примеры применения
Практические примеры использования

## Связанные темы
- [[путь/к/файлу.md]] - описание связи
- [[другой/файл.md]] - описание связи

## Источники
- URL источника
- Дополнительные ссылки
```

## Логика агента

### Как агент принимает решения

```
1. Анализ источника
   ↓
   Определение типа: статья/описание/новость/заметка

2. Извлечение тем
   ↓
   Список тем: [тема1, тема2, тема3, ...]

3. Оценка разбиения
   ↓
   Если тем > 1 → создать отдельные файлы
   Если тем = 1 → один файл

4. Определение структуры папок
   ↓
   Какие папки нужны?
   ai/models, tech/frameworks, companies, etc.

5. Создание папок
   ↓
   folder_create для каждой нужной папки

6. Создание файлов
   ↓
   file_create для каждой темы
   Содержимое НА РУССКОМ языке

7. Связывание
   ↓
   file_edit для добавления ссылок между файлами

8. Проверка
   ↓
   Вся ли информация учтена?
   Все ли файлы связаны?
```

## Структура папок

Агент использует следующую организацию:

```
knowledge_base/
├── ai/
│   ├── models/          # AI модели (GPT, Claude, etc.)
│   ├── concepts/        # Концепции AI
│   ├── agents/          # AI агенты
│   ├── multimodal/      # Мультимодальные возможности
│   ├── rag/             # RAG и retrieval
│   └── vision/          # Computer Vision
│
├── tech/
│   ├── frameworks/      # Фреймворки
│   ├── languages/       # Языки программирования
│   ├── databases/       # Базы данных
│   └── tools/           # Инструменты
│
├── companies/           # Компании и организации
│
├── applications/        # Практические применения
│   ├── medical/         # Медицина
│   ├── finance/         # Финансы
│   └── education/       # Образование
│
├── science/
│   ├── physics/         # Физика
│   ├── biology/         # Биология
│   └── chemistry/       # Химия
│
└── concepts/            # Общие концепции
```

## Примеры использования

### Через Telegram бота

Просто отправьте сообщение:

```
Пользователь:
Новая статья о Gemini 1.5 от Google. Модель поддерживает
контекст в 1 миллион токенов и работает с видео.

Бот → qwen-code CLI агент:

1. Анализирует статью
2. Определяет темы:
   - Модель Gemini
   - Компания Google
   - Длинный контекст
   - Мультимодальность (видео)

3. Создаёт файлы:
   - ai/models/gemini.md
   - companies/google.md
   - ai/multimodal/video-understanding.md

4. Связывает файлы

Бот → Пользователю:
✅ Информация добавлена в базу знаний:
   - ai/models/gemini.md
   - companies/google.md
   - ai/multimodal/video-understanding.md
```

### Программное использование

```python
from src.agents.qwen_code_cli_agent import QwenCodeCLIAgent

agent = QwenCodeCLIAgent(
    qwen_cli_path="qwen",
    enable_web_search=True
)

content = {
    "text": """
    Статья о новом фреймворке AutoGen от Microsoft
    для создания мультиагентных систем. Поддерживает
    разговоры между агентами и tool calling.
    """,
    "urls": ["https://microsoft.github.io/autogen/"]
}

result = await agent.process(content)

# Агент создаст:
# - tech/frameworks/autogen.md
# - companies/microsoft.md
# - ai/agents/multi-agent-systems.md
# - ai/agents/agent-communication.md

print(f"Создано файлов: {len(result['metadata']['files_created'])}")
print(result['markdown'])
```

## Конфигурация

### config.yaml

```yaml
# Использовать qwen-code CLI агент
AGENT_TYPE: "qwen_code_cli"

# Настройки
AGENT_QWEN_CLI_PATH: "qwen"
AGENT_TIMEOUT: 300
AGENT_ENABLE_WEB_SEARCH: true

# Путь к базе знаний
KB_PATH: "/path/to/knowledge_base"
```

## Особенности

### ✅ Преимущества

1. **Автоматическое разбиение по темам**
   - Агент сам определяет темы
   - Создаёт отдельные файлы
   - Не нужно вручную разбивать

2. **Структурированная организация**
   - Создаёт нужные папки
   - Логичная иерархия
   - Легко найти информацию

3. **Связанность информации**
   - Файлы ссылаются друг на друга
   - Можно переходить между темами
   - Полнота картины

4. **Автономность**
   - qwen CLI сам составляет план
   - Сам выполняет действия
   - Сам проверяет результат

5. **Web search интеграция**
   - Ищет дополнительную информацию
   - Изучает ссылки
   - Обогащает контент

### ⚠️ Важные моменты

1. **Язык: РУССКИЙ**
   - Все файлы на русском
   - Агент переводит если нужно
   - Проверяет язык в плане

2. **Относительные пути**
   - ai/models/gpt4.md ✅
   - /home/user/kb/ai/models/gpt4.md ❌

3. **Timeout**
   - По умолчанию 300 секунд (5 минут)
   - Увеличьте если много тем
   - Настраивается в config.yaml

4. **Web search**
   - Включен по умолчанию
   - Увеличивает время обработки
   - Обогащает информацию

## Логи и отладка

```python
import logging

# Включить DEBUG логи
logging.getLogger("src.agents.qwen_code_cli_agent").setLevel(logging.DEBUG)

# Логи покажут:
# - Какие темы определил агент
# - Какие папки создаёт
# - Какие файлы создаёт
# - Как связывает файлы
```

## FAQ

### Q: Всегда ли создаётся несколько файлов?

A: Нет, только если агент определит несколько тем. Для одной темы - один файл.

### Q: Можно ли контролировать структуру папок?

A: Агент сам определяет структуру на основе анализа. Можно указать в инструкции предпочтительную структуру.

### Q: Как файлы связываются?

A: Агент добавляет секцию "## Связанные темы" с ссылками в формате `[[путь/файл.md]]`.

### Q: Что если файл уже существует?

A: Агент может обновить существующий файл через `file_edit`, добавив новую информацию.

### Q: На каком языке файлы?

A: НА РУССКОМ! Это прописано в инструкции, агент переводит контент.

### Q: Сколько времени занимает обработка?

A: Зависит от количества тем и web search:
- 1-2 темы без поиска: 10-30 секунд
- 3-5 тем с поиском: 1-3 минуты
- Много тем с глубоким анализом: до 5 минут

### Q: Можно ли посмотреть план агента?

A: Да, агент создаёт TODO plan в начале, который можно увидеть в metadata результата.

## Примеры реальных сценариев

### Сценарий 1: Анализ научной статьи

**Вход:**
```
Forwarded: https://arxiv.org/abs/2401.12345
Статья о новом методе обучения трансформеров с использованием
sparse attention и его применении в генерации кода.
```

**Выход (агент создаст):**
```
ai/architectures/transformers.md           # Трансформеры
ai/attention/sparse-attention.md           # Sparse attention
ai/code-generation/transformer-codegen.md  # Генерация кода
tech/optimization/training-methods.md      # Методы обучения
```

### Сценарий 2: Новость из блога

**Вход:**
```
OpenAI announces GPT-5 with reasoning capabilities
and improved math problem solving
```

**Выход:**
```
companies/openai.md                   # OpenAI компания
ai/models/gpt5.md                     # GPT-5 модель
ai/reasoning/reasoning-models.md      # Reasoning в AI
ai/math/math-solving.md               # Решение математических задач
```

### Сценарий 3: Заметка с идеей

**Вход:**
```
Идея: использовать RAG для персонализации промптов
на основе истории пользователя. Можно комбинировать
с fine-tuning для лучших результатов.
```

**Выход:**
```
concepts/ideas/rag-personalization.md      # Идея RAG персонализации
ai/rag/rag-applications.md                 # Применения RAG
ai/fine-tuning/personalization.md          # Персонализация через FT
```

## Текущее поведение

**Сейчас агент:**
- ✅ Анализирует контент
- ✅ Определяет категорию
- ✅ Создаёт ОДИН файл со всем содержимым
- ✅ Работает автономно
- ✅ Использует web search для обогащения (опционально)
- ✅ Создаёт контент на русском языке

**Telegram уведомление:**
```
✅ Сообщение успешно обработано и сохранено!

📁 Файл: `2025-10-03-gpt4-vision.md`
📂 Категория: `ai`
🏷 Теги: gpt4, vision, multimodal
🔗 Путь: `topics/ai/2025-10-03-gpt4-vision.md`
```

## Планируемое поведение

**После реализации:**
- ✅ Разбиение информации по темам автоматически
- ✅ Создание нескольких файлов из одного сообщения
- ✅ Организация структуры папок
- ✅ Связывание файлов между собой

**Telegram уведомление (будущее):**
```
✅ Сообщение успешно обработано и сохранено!

📁 Создано файлов: 3

  • `topics/ai/models/gpt4.md`
  • `topics/ai/multimodal/vision-models.md`
  • `topics/applications/medical/ai-diagnostics.md`
```

## Заключение

**Текущая реализация:**

Инфраструктура бота готова к поддержке множественных файлов:
- ✅ KnowledgeBaseManager может создавать несколько файлов
- ✅ Handlers обрабатывают список файлов
- ✅ Git операции работают с множественными файлами
- ✅ Telegram показывает информацию о всех файлах

**Что требуется:**
- ❌ Обновить агентов для возврата множественных файлов
- ❌ Реализовать логику разбиения по темам
- ❌ Протестировать с реальными данными

Просто отправьте информацию боту - агент создаст файл в базе знаний!

---

**См. также:**
- [AGENT_OUTPUT_VERIFICATION.md](../AGENT_OUTPUT_VERIFICATION.md) - детальный анализ текущей реализации
- [handlers.py](../src/bot/handlers.py) - код обработки множественных файлов
- [manager.py](../src/knowledge_base/manager.py) - `create_multiple_articles()`

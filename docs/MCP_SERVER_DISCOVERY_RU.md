# Обнаружение MCP Серверов

## Обзор

Система теперь поддерживает **автоматическое обнаружение MCP серверов** с поддержкой как **общих**, так и **пользовательских** MCP серверов. Агенты автоматически обнаруживают и подключаются к доступным MCP серверам, делая их инструменты доступными для использования.

## Как это работает

### Процесс обнаружения

Когда создается агент для пользователя, система:

1. **Обнаруживает общие MCP серверы** из `data/mcp_servers/`
2. **Обнаруживает пользовательские MCP серверы** из `data/mcp_servers/user_{user_id}/`
3. **Подключается ко всем включенным серверам**
4. **Запрашивает у каждого сервера доступные инструменты**
5. **Регистрирует инструменты** в менеджере инструментов агента

Пользовательские серверы **переопределяют** общие серверы с тем же именем.

### Архитектура

```
data/mcp_servers/
├── mem-agent.json              # Общий MCP сервер (доступен всем пользователям)
├── filesystem.json             # Еще один общий сервер
├── user_123456/                # Пользовательские серверы для user 123456
│   ├── mem-agent.json          # Переопределяет общий mem-agent для этого пользователя
│   └── custom-tool.json        # Пользовательский инструмент
└── user_789012/                # Пользовательские серверы для user 789012
    └── private-api.json        # Приватное API только для этого пользователя
```

## Конфигурация MCP сервера

### Формат файла конфигурации

Каждый MCP сервер настраивается через JSON файл:

```json
{
  "name": "my-mcp-server",
  "description": "Описание MCP сервера",
  "command": "python",
  "args": ["-m", "my_package.server"],
  "env": {
    "API_KEY": "your-api-key",
    "CONFIG_PATH": "/path/to/config"
  },
  "working_dir": "/path/to/working/directory",
  "enabled": true
}
```

**Поля:**
- `name` (обязательно): Уникальный идентификатор сервера
- `description` (обязательно): Читаемое описание
- `command` (обязательно): Команда для запуска сервера
- `args` (опционально): Аргументы командной строки
- `env` (опционально): Переменные окружения
- `working_dir` (опционально): Рабочая директория для процесса сервера
- `enabled` (опционально): Включен ли сервер (по умолчанию: true)

## Использование

### Для конечных пользователей (через Telegram бот)

1. **Просмотр доступных серверов**: `/listmcpservers`
2. **Добавить новый сервер**: `/addmcpserver` (затем вставить JSON конфиг)
3. **Включить сервер**: `/enablemcp <server_name>`
4. **Отключить сервер**: `/disablemcp <server_name>`
5. **Удалить сервер**: `/removemcp <server_name>`

Серверы, добавленные пользователем, автоматически размещаются в пользовательской директории.

### Для разработчиков

#### Программный доступ

```python
from src.mcp_registry import MCPServersManager

# Создать менеджер для конкретного пользователя
manager = MCPServersManager(user_id=123456)
manager.initialize()

# Получить все доступные серверы (общие + пользовательские)
all_servers = manager.get_all_servers()
enabled_servers = manager.get_enabled_servers()

# Добавить новый сервер
manager.add_server_from_json(json_content)

# Включить/отключить серверы
manager.enable_server("my-server")
manager.disable_server("my-server")
```

## Интеграция с агентами

### Автоматическое обнаружение инструментов

Когда `AGENT_ENABLE_MCP=true`, агенты автоматически:

1. Обнаруживают все доступные MCP серверы для пользователя
2. Подключаются к включенным серверам
3. Запрашивают у каждого сервера доступные инструменты
4. Регистрируют инструменты с именами вида `mcp_{server_name}_{tool_name}`

Пример: Если сервер `mem-agent` имеет инструмент `store_memory`, он становится:
- Имя инструмента в агенте: `mcp_mem_agent_store_memory`

### Конфигурация

Установить в `.env` или через менеджер настроек:

```bash
# Включить поддержку MCP
AGENT_ENABLE_MCP=true

# Включить legacy MCP memory tool (опционально)
AGENT_ENABLE_MCP_MEMORY=false
```

## Структура директорий

```
data/
└── mcp_servers/
    ├── shared-server-1.json         # Общие серверы
    ├── shared-server-2.json
    ├── user_123456/                 # Серверы пользователя 123456
    │   ├── server-override.json
    │   └── user-specific.json
    └── user_789012/                 # Серверы пользователя 789012
        └── another-user-server.json
```

## Лучшие практики

### 1. Общие vs Пользовательские серверы

**Используйте общие серверы для:**
- Общей функциональности (как mem-agent)
- Сервисов только для чтения
- Инструментов без состояния

**Используйте пользовательские серверы для:**
- Пользовательских API ключей
- Доступа к персональным данным
- Кастомных пользовательских конфигураций

### 2. Безопасность

- **Никогда не размещайте чувствительные данные в общих конфигах**
- Используйте переменные окружения для секретов
- Храните пользовательские credentials в пользовательских директориях
- Проверяйте загруженные пользователями конфиги перед включением

## Итоги

Система обнаружения MCP серверов предоставляет:

✅ **Автоматическое обнаружение** MCP серверов  
✅ **Поддержку пользовательских конфигураций**  
✅ **Общие и пользовательские** серверы  
✅ **Механизм переопределения** для кастомизации  
✅ **Динамическую регистрацию инструментов**  
✅ **Интеграцию с Telegram ботом**  
✅ **Простую конфигурацию** через JSON файлы  

Это упрощает расширение возможностей агента с помощью кастомных MCP серверов, сохраняя безопасность и изоляцию пользователей.

## Детали реализации

### Основные изменения

1. **MCPServerRegistry** (`src/mcp_registry/registry.py`):
   - Добавлен параметр `user_id` в конструктор
   - Метод `discover_servers()` теперь сканирует как общую директорию, так и пользовательскую
   - Пользовательские серверы переопределяют общие с тем же именем

2. **MCPServersManager** (`src/mcp_registry/manager.py`):
   - Добавлен параметр `user_id` для инициализации
   - Передает `user_id` в MCPServerRegistry

3. **MCPRegistryClient** (`src/agents/mcp/registry_client.py`):
   - Поддержка `user_id` для обнаружения пользовательских серверов
   - Автоматическое подключение к доступным серверам

4. **DynamicMCPTools** (`src/agents/mcp/dynamic_mcp_tools.py`):
   - Новый модуль для динамического обнаружения и создания инструментов
   - Автоматическое создание BaseTool для каждого инструмента из MCP сервера
   - Поддержка пользовательских серверов

5. **ToolManager** (`src/agents/tools/registry.py`):
   - Интеграция с динамическим обнаружением MCP инструментов
   - Автоматическая регистрация обнаруженных инструментов

6. **AutonomousAgent** (`src/agents/autonomous_agent.py`):
   - Извлечение `user_id` из конфига
   - Передача `user_id` в ToolManager

7. **UserContextManager** (`src/services/user_context_manager.py`):
   - Добавление `user_id` в конфиг агента при создании
   - Передача настроек MCP в конфигурацию агента
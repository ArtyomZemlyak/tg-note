# tg-note

Telegram-бот для преобразования сообщений и репостов в структурированные заметки (Markdown) в GitHub-репозитории знаний. Анализ выполняется через агентную систему (провайдер настраивается), результат сохраняется в `.md` файлы и попадает в базу знаний через коммит или PR.

### Цели
- **Автоматизация захвата знаний**: пересланные сообщения, ссылки и заметки превращаются в структурированный контент.
- **Агентный анализ**: LLM/агент извлекает ключевую информацию, классифицирует и нормализует данные.
- **GitOps для знаний**: всё хранится как Markdown в GitHub с историей изменений.

## Архитектура

### Компоненты
- **Telegram Bot**: получает апдейты (webhook или polling), валидирует отправителей, нормализует вход.
- **Message Normalizer**: приводит сообщения, репосты и вложения к единому представлению (текст + метаданные).
- **Agent Orchestrator**: абстрактный слой поверх провайдеров (OpenAI Assistants / LangChain / LlamaIndex / локальный LLM via Ollama). Контракты: `analyze_message`, `classify`, `extract_entities`, `summarize`.
- **Knowledge Router**: решает, куда и в каком виде сохранить знания: выбор каталога/файла, заголовка, тегов, фронтматтера, стратегии слияния/создания.
- **GitHub Knowledge Writer**: формирует Markdown с фронтматтером, делает коммит в ветку или создаёт PR. Путь и имя файла определяет Router.
- **State & Idempotency**: хранилище состояния для дедупликации апдейтов (`chat_id:message_id`), трекинга прогресса, ретраев. Для MVP: SQLite/файл; прод: Redis/Postgres.
- **Observability**: структурированные логи, корелляция по `request_id`, метрики ошибок, latency. Прод: OpenTelemetry/Prometheus.

### Поток данных
1. Пользователь отправляет сообщение/репост в бота.
2. **Bot** принимает апдейт (webhook/polling), выполняет авторизацию и базовую валидацию.
3. **Normalizer** извлекает текст, ссылки, вложения, метаданные (источник, автор, дата, ссылка на оригинал).
4. **Agent Orchestrator** вызывает агентную систему для: классификации тематики, извлечения сущностей, резюмирования, определения тегов.
5. **Knowledge Router** выбирает целевую директорию/файл, стратегию (создать новую заметку или апдейтить существующую секцию), формирует заголовок и frontmatter.
6. **Knowledge Writer** генерирует Markdown, коммитит в рабочую ветку или открывает PR в default-ветку.
7. **Bot** возвращает пользователю ссылку на коммит/PR/файл и краткий итог.

### Формат заметки (Markdown)
```markdown
---
title: "<Заголовок>"
created_at: "<ISO8601>"
source:
  type: "telegram|link|repost"
  chat_id: "<id>"
  message_id: "<id>"
  url: "<если есть>"
tags: ["agent", "nlp", "knowledge"]
summary: "Краткое резюме от агента"
---

# <Заголовок>

<Нормализованный контент и выделенные пункты>

## Highlights
- Пункт 1
- Пункт 2
```

### Стратегия именования файлов
- Путь: `knowledge/<категория>/<год>/<месяц>/`
- Имя файла: `<yyyy-mm-dd>-<slug>.md`
- Категория и slug выводятся из классификации и заголовка.

### Интеграции агентной системы (варианты)
- **OpenAI Assistants API**: быстрая интеграция, инструменты, файлы, код-интерпретер.
- **LangChain**: гибкий конструктор агентных графов с провайдерами моделей (OpenAI, Anthropic, Azure OpenAI, и т.д.).
- **LlamaIndex**: удобная работа с документами, индексацией и извлечением.
- **Ollama/Local LLM**: локальный провайдер для приватности и экономии.

Интерфейс делаем провайдер-независимым; выбор задаётся переменной `AGENT_PROVIDER`.

### GitHub стратегия
- По умолчанию — **PR-flow**: изменения в feature-ветку, далее PR в `default` ветку репозитория.
- Альтернатива — прямой коммит в защищённую ветку (не рекомендуется без ревью).
- Git-автор: `tg-note-bot <bot@local>`; подпись коммитов по возможности.

### Безопасность
- Белый список пользователей/чатов в конфиге или в БД.
- Rate limiting, базовая защита от спама.
- Секреты только через переменные окружения/секрет-менеджер.
- Токен GitHub с минимальными правами: `repo` (contents, pull_requests).

## Структура проекта (план)
```
tg-note/
  bot/
    app.py                # вход, webhook/polling
    handlers.py           # хэндлеры сообщений/репостов
    normalizer.py         # нормализация входа
    security.py           # авторизация/allowlist
  agent/
    base.py               # интерфейсы провайдера
    openai_provider.py    # пример реализации
    router.py             # выбор папки/файла/стратегии
  knowledge/
    writer.py             # запись/обновление .md
    paths.py              # генерация путей/slug
  infra/
    github.py             # обёртка над Git (PyGit2/git cli)
    state.py              # идемпотентность (sqlite/redis)
    logging.py            # логи/метрики
  scripts/
    dev_run.sh            # локальный запуск
  tests/
    test_router.py
    test_writer.py
  README.md
  LICENSE
  pyproject.toml | requirements.txt
```

## Переменные окружения
- `TELEGRAM_BOT_TOKEN` — токен бота
- `TELEGRAM_WEBHOOK_SECRET` — секрет подписи webhook (если применяется)
- `ALLOWED_USER_IDS` — список id через запятую
- `AGENT_PROVIDER` — `openai|langchain|llamaindex|ollama`
- `OPENAI_API_KEY` — при `AGENT_PROVIDER=openai|langchain`
- `GITHUB_TOKEN` — PAT с правами `repo`
- `GITHUB_REPO` — `owner/repo` (по умолчанию текущий)
- `GITHUB_BRANCH` — рабочая ветка для коммитов (например, `notes-bot`)

## Запуск (MVP)
1. Установить зависимости (Python 3.11+):
   - `pip install -r requirements.txt` или `poetry install`
2. Заполнить `.env`/переменные окружения.
3. Запуск в режиме polling: `python -m bot.app`
4. Для webhook: задеплоить и выставить URL/секрет.

## Дорожная карта (TODO)
- **Инициализация проекта**
  - Создать структуру каталогов, `pyproject.toml`/`requirements.txt`
  - Базовая конфигурация логирования
- **Telegram Bot (MVP)**
  - Поддержка текста и репостов, allowlist, polling
  - Нормализация входа и валидация
- **Agent Orchestrator (MVP)**
  - Базовый провайдер `openai` с функциями: `classify`, `summarize`, `extract`
  - Конфигурация через `AGENT_PROVIDER`
- **Knowledge Router & Writer**
  - Генерация пути/имени файла, slug, frontmatter
  - Создание/обновление `.md` с идемпотентностью
- **GitHub интеграция**
  - Коммит в рабочую ветку и создание PR в default ветку
  - Выдача пользователю ссылки на PR/файл
- **Тесты**
  - Unit-тесты для `router`, `writer`
  - E2E тест апдейта с моками
- **Прод-улучшения**
  - Webhook, Redis, метрики, ретраи, обработка медиа/файлов

## Развёртывание
- Контейнеризация (Dockerfile) и запуск на Railway/Fly.io/Render.
- GitHub Actions: тесты, линтеры, авто-PR с метками.

---

Если вы читаете этот файл в PR — он описывает целевую архитектуру и план работ для первой итерации внедрения.

# –°–≤–æ–¥–∫–∞: MCP Memory Agent —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–µ–Ω

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–í—Å–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–≥–µ–Ω—Ç–æ–≤ —Ç–µ–ø–µ—Ä—å **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** –∏—Å–ø–æ–ª—å–∑—É—é—Ç mem-agent MCP HTTP —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞–º—è—Ç–∏. –≠—Ç–æ –∫–ª—é—á–µ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã, –∫–æ—Ç–æ—Ä–∞—è –±–æ–ª—å—à–µ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π.

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### 1. ‚úÖ ToolManager (`src/agents/tools/registry.py`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –£–¥–∞–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `enable_mcp_memory` –∏–∑ `build_default_tool_manager`
- MCP memory –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ç–µ–ø–µ—Ä—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è **–í–°–ï–ì–î–ê** (–¥–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ `enable_mcp`)
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, —É–∫–∞–∑—ã–≤–∞—é—â–∞—è, —á—Ç–æ MCP memory - —ç—Ç–æ core feature

**–ö–æ–¥:**
```python
# MCP Memory Agent Tools - ALWAYS ENABLED
# All agents use mem-agent MCP HTTP server for memory storage/retrieval
try:
    from ..mcp import memory_agent_tool
    for tool in memory_agent_tool.ALL_TOOLS:
        tool.enable()
    manager.register_many(memory_agent_tool.ALL_TOOLS)
    logger.info("[ToolManager] MCP memory agent tools enabled (always on)")
except ImportError as e:
    logger.warning(f"[ToolManager] Failed to import MCP memory tools: {e}")
```

### 2. ‚úÖ AutonomousAgent (`src/agents/autonomous_agent.py`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –£–¥–∞–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `enable_mcp_memory` –∏–∑ `__init__`
- –£–¥–∞–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `self.enable_mcp_memory`
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å –ø–æ–º–µ—Ç–∫–æ–π, —á—Ç–æ MCP memory –≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–µ–Ω
- –£–¥–∞–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ –≤—ã–∑–æ–≤–∞ `build_default_tool_manager`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- MCP memory –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ `tool_manager` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ê–≥–µ–Ω—Ç –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `memory_store`, `memory_search` –∏ `mcp_memory_agent` –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### 3. ‚úÖ QwenCodeCLIAgent (`src/agents/qwen_code_cli_agent.py`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –£–¥–∞–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `enable_mcp` - MCP –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–í–°–ï–ì–î–ê**
- `_setup_qwen_mcp_config()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- `get_mcp_tools_description()` –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- `.qwen/settings.json` –≤—Å–µ–≥–¥–∞ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —Å mem-agent —Å–µ—Ä–≤–µ—Ä–æ–º
- Qwen CLI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ MCP memory –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º

### 4. ‚úÖ StubAgent (`src/agents/stub_agent.py`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `kb_root_path` –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
- –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_init_mcp_memory()` –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ MCP memory –∫–ª–∏–µ–Ω—Ç–∞
- –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_store_in_memory()` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ø–∞–º—è—Ç–∏
- –í `process()` –¥–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ `_store_in_memory()` –¥–ª—è –∑–∞–ø–∏—Å–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- StubAgent —Ç–µ–ø–µ—Ä—å –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–Ω—Ç—ã –≤ mem-agent
- –ú–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–µ—Ä–µ–∑ MCP memory search

### 5. ‚úÖ AgentFactory (`src/agents/agent_factory.py`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –£–¥–∞–ª–µ–Ω–æ `enable_mcp_memory` –∏–∑ `from_settings()` –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –£–¥–∞–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ `_create_autonomous_agent()`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ–∞–±—Ä–∏–∫–∞ `_create_stub_agent()` –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ `kb_root_path`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –í—Å–µ –∞–≥–µ–Ω—Ç—ã, —Å–æ–∑–¥–∞–≤–∞–µ–º—ã–µ —á–µ—Ä–µ–∑ —Ñ–∞–±—Ä–∏–∫—É, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç MCP memory –ø–æ–¥–¥–µ—Ä–∂–∫—É

### 6. ‚úÖ Settings (`config/settings.py`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- `AGENT_ENABLE_MCP_MEMORY` –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ **[DEPRECATED]**
- –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ `True`
- –û–±–Ω–æ–≤–ª–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ: "MCP memory agent is now ALWAYS enabled. This setting is kept for backward compatibility."

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏
- –ß–µ—Ç–∫–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ, —á—Ç–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

### 7. ‚úÖ MCPServerManager (`src/agents/mcp/server_manager.py`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- `setup_default_servers()` —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç mem-agent —Å–µ—Ä–≤–µ—Ä
- –£–¥–∞–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `if self.settings.AGENT_ENABLE_MCP_MEMORY`
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ª–æ–≥–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- mem-agent —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### 8. ‚úÖ –¢–µ—Å—Ç—ã

**–û–±–Ω–æ–≤–ª–µ–Ω—ã —Ñ–∞–π–ª—ã:**
- `tests/test_stub_agent.py` - –¥–æ–±–∞–≤–ª–µ–Ω `kb_root_path` –ø–∞—Ä–∞–º–µ—Ç—Ä, –¥–æ–±–∞–≤–ª–µ–Ω —Ç–µ—Å—Ç MCP memory –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- `tests/test_agent_factory.py` - –æ–±–Ω–æ–≤–ª–µ–Ω—ã mock –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —É–¥–∞–ª–µ–Ω—ã —Å—Å—ã–ª–∫–∏ –Ω–∞ `AGENT_ENABLE_MCP_MEMORY`, –æ–±–Ω–æ–≤–ª–µ–Ω —Ç–µ—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∞–≥–µ–Ω—Ç–æ–≤

## –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π API

**–ë—ã–ª–æ:**
```python
agent = AutonomousAgent(
    llm_connector=connector,
    enable_mcp_memory=True  # ‚ùå –ë–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–æ
)
```

**–°—Ç–∞–ª–æ:**
```python
agent = AutonomousAgent(
    llm_connector=connector
    # MCP memory –≤–∫–ª—é—á–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚úÖ
)
```

### –î–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

**config.yaml / .env:**
```yaml
# AGENT_ENABLE_MCP_MEMORY: false  # ‚ö†Ô∏è DEPRECATED - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
# –ë–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å, mem-agent –≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–µ–Ω
```

### –î–ª—è AgentFactory

**–ë—ã–ª–æ:**
```python
config = {
    "enable_mcp_memory": True  # ‚ùå –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
}
agent = AgentFactory.create_agent("autonomous", config)
```

**–°—Ç–∞–ª–æ:**
```python
config = {}  # MCP memory –≤–∫–ª—é—á–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚úÖ
agent = AgentFactory.create_agent("autonomous", config)
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: –ë–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å –æ –≤–∫–ª—é—á–µ–Ω–∏–∏ MCP memory
2. **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: –í—Å–µ –∞–≥–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ
3. **–õ—É—á—à–∏–π UX**: –ê–≥–µ–Ω—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–æ–≥—É—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –∏ –∏—Å–∫–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
4. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –°—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å

## –ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

- HTTP MCP —Å–µ—Ä–≤–µ—Ä (`mem_agent_server_http.py`) —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
- API MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (`store_memory`, `retrieve_memory`, `list_categories`) –æ—Å—Ç–∞–ª—Å—è –ø—Ä–µ–∂–Ω–∏–º
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ per-user storage —á–µ—Ä–µ–∑ `user_id`

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –õ–∏–Ω—Ç–µ—Ä
```bash
# –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã - –æ—à–∏–±–æ–∫ –Ω–µ—Ç ‚úÖ
```

### –¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ
- `test_stub_agent.py` - –æ–±–Ω–æ–≤–ª–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É
- `test_agent_factory.py` - –æ–±–Ω–æ–≤–ª–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É
- –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π —Ç–µ—Å—Ç `test_stub_agent_mcp_memory_integration`

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–Ω–µ—Å–µ–Ω—ã –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã
2. ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
3. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
4. üîÑ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –≤ README.md –∏ –¥—Ä—É–≥–∏—Ö —Ñ–∞–π–ª–∞—Ö docs/

## –§–∞–π–ª—ã, –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –≤ —ç—Ç–æ–º PR

1. `src/agents/tools/registry.py` - ToolManager –≤—Å–µ–≥–¥–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç MCP memory
2. `src/agents/autonomous_agent.py` - —É–¥–∞–ª–µ–Ω enable_mcp_memory –ø–∞—Ä–∞–º–µ—Ç—Ä
3. `src/agents/qwen_code_cli_agent.py` - MCP –≤—Å–µ–≥–¥–∞ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è
4. `src/agents/stub_agent.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ MCP memory –ø–æ–¥–¥–µ—Ä–∂–∫–∞
5. `src/agents/agent_factory.py` - –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Ñ–∞–±—Ä–∏–∫–∏ –∞–≥–µ–Ω—Ç–æ–≤
6. `config/settings.py` - AGENT_ENABLE_MCP_MEMORY –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ deprecated
7. `src/agents/mcp/server_manager.py` - mem-agent —Å–µ—Ä–≤–µ—Ä –≤—Å–µ–≥–¥–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è
8. `tests/test_stub_agent.py` - –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã
9. `tests/test_agent_factory.py` - –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã

---

**–î–∞—Ç–∞:** 2025-10-08  
**–ê–≤—Ç–æ—Ä:** Background Agent (Cursor)  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

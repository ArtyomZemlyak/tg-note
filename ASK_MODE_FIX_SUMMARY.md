# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ `/ask` - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞

## –ü—Ä–æ–±–ª–µ–º–∞

–†–µ–∂–∏–º `/ask` —Ä–∞–±–æ—Ç–∞–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
1. –ê–≥–µ–Ω—Ç –≤–æ–∑–≤—Ä–∞—â–∞–ª –≤–µ—Å—å –≤—ã–≤–æ–¥ (–≤–∫–ª—é—á–∞—è –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–∏—Å–∫–∞), –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
2. –û—Ç–≤–µ—Ç –Ω–µ –≤—Å–µ–≥–¥–∞ –±—ã–ª –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
3. –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –±—ã–ª –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º - –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞—Å—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤–º–µ—Å—Ç–æ –ø–æ–Ω—è—Ç–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞

## –ü—Ä–∏—á–∏–Ω–∞

–í –∫–æ–¥–µ –±—ã–ª —Ä–∞–∑—Ä—ã–≤ –º–µ–∂–¥—É —Ç–µ–º, —á—Ç–æ –∞–≥–µ–Ω—Ç –≤–æ–∑–≤—Ä–∞—â–∞–ª –∏ —Ç–µ–º, —á—Ç–æ –æ–∂–∏–¥–∞–ª –∫–æ–¥ –ø–∞—Ä—Å–∏–Ω–≥–∞:

1. **–ü—Ä–æ–º–ø—Ç `KB_QUERY_PROMPT_TEMPLATE`** –ø—Ä–æ—Å–∏–ª –∞–≥–µ–Ω—Ç–∞ –≤–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –±–ª–æ–∫–µ `agent-result` —Å –ø–æ–ª–µ–º `answer`
2. **–ú–µ—Ç–æ–¥ `parse_agent_response`** –≤ `base_agent.py` –ù–ï –∏–∑–≤–ª–µ–∫–∞–ª –ø–æ–ª–µ `answer` –∏–∑ –±–ª–æ–∫–∞ `agent-result`
3. **–ö–æ–¥ –≤ `question_answering_service.py`** –∏—Å–∫–∞–ª –∫–ª—é—á `answer` –≤ response, –Ω–æ –µ–≥–æ —Ç–∞–º –Ω–µ –±—ã–ª–æ
4. –í –ø—Ä–æ–º–ø—Ç–µ –Ω–µ –±—ã–ª–æ —á—ë—Ç–∫–æ–≥–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –¥–ª—è –∫–æ–Ω–µ—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## –†–µ—à–µ–Ω–∏–µ

### 1. –û–±–Ω–æ–≤–ª—ë–Ω –ø—Ä–æ–º–ø—Ç `KB_QUERY_PROMPT_TEMPLATE` (`config/agent_prompts.py`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω—ã —è—Ä–∫–∏–µ –º–∞—Ä–∫–µ—Ä—ã üî¥ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º –æ—Ç–≤–µ—á–∞—Ç—å –ù–ê –†–£–°–°–ö–û–ú
- –Ø–≤–Ω–æ —É–∫–∞–∑–∞–Ω–æ, —á—Ç–æ –ø–æ–ª–µ `answer` - —ç—Ç–æ –ò–¢–û–ì–û–í–´–ô –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- –ü–æ–¥—á—ë—Ä–∫–Ω—É—Ç–æ, —á—Ç–æ –≤ `answer` –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–æ–∏—Å–∫–∞
- –î–æ–±–∞–≤–ª–µ–Ω –ø—Ä–∏–º–µ—Ä —Ö–æ—Ä–æ—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞
- –£–ª—É—á—à–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ –±–ª–æ–∫–∞ `agent-result`

**–ö–ª—é—á–µ–≤—ã–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:**
```
üî¥ –ö–†–ò–¢–ò–ß–ù–û: –¢–≤–æ–π –æ—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫ - –†–£–°–°–ö–ò–ô! –í–°–ï –æ—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¢–û–õ–¨–ö–û –Ω–∞ –†–£–°–°–ö–û–ú —è–∑—ã–∫–µ!
üî¥ –í–ê–ñ–ù–û: –û—Ç–≤–µ—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ü–û–ù–Ø–¢–ù–û –∏ –°–¢–†–£–ö–¢–£–†–ò–†–û–í–ê–ù–ù–û!

–í–ù–ò–ú–ê–ù–ò–ï: –ü–æ–ª–µ "answer" - —ç—Ç–æ –ò–¢–û–ì–û–í–´–ô –û–¢–í–ï–¢ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é! –û–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
- –ù–∞ –†–£–°–°–ö–û–ú —è–∑—ã–∫–µ
- –ü–æ–ª–Ω—ã–º –∏ –∏—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∏–º
- –ü–æ–Ω—è—Ç–Ω—ã–º –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –° —É–∫–∞–∑–∞–Ω–∏–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- –•–æ—Ä–æ—à–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –≤ markdown

–≠—Ç–æ –ø–æ–ª–µ –Ω–∞–ø—Ä—è–º—É—é –ø–æ–∫–∞–∂–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –ø–æ—ç—Ç–æ–º—É –ù–ï –ø–∏—à–∏ —Ç—É–¥–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–æ–∏—Å–∫–∞!
```

### 2. –û–±–Ω–æ–≤–ª—ë–Ω `AgentResult` –∫–ª–∞—Å—Å (`src/agents/base_agent.py`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `answer: Optional[str] = None` –≤ dataclass `AgentResult`
- –ü–æ–ª–µ `answer` –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –º–µ—Ç–æ–¥ `to_dict()`

**–ö–æ–¥:**
```python
@dataclass
class AgentResult:
    # ... existing fields ...
    answer: Optional[str] = None  # For ask mode - final answer to user
```

### 3. –û–±–Ω–æ–≤–ª—ë–Ω –º–µ—Ç–æ–¥ `parse_agent_response` (`src/agents/base_agent.py`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ–ª—è `answer` –∏–∑ –±–ª–æ–∫–∞ `agent-result`
- –ü–æ–ª–µ `answer` –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä `AgentResult`

**–ö–æ–¥:**
```python
answer = None

# In JSON parsing block:
answer = result_data.get("answer")  # Extract answer for ask mode

# In return statement:
return AgentResult(
    # ... existing fields ...
    answer=answer
)
```

### 4. –û–±–Ω–æ–≤–ª—ë–Ω `QwenCodeCLIAgent.process()` (`src/agents/qwen_code_cli_agent.py`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `answer` –≤ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–ö–æ–¥:**
```python
result = {
    "markdown": agent_result.markdown,
    "metadata": metadata,
    "title": title,
    "kb_structure": kb_structure,
    "answer": agent_result.answer  # Include answer for ask mode
}
```

### 5. –û–±–Ω–æ–≤–ª—ë–Ω `QuestionAnsweringService._query_kb()` (`src/services/question_answering_service.py`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞: —Å–Ω–∞—á–∞–ª–∞ `answer`, –∑–∞—Ç–µ–º `markdown`, –∑–∞—Ç–µ–º `text`
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è, –µ—Å–ª–∏ –ø–æ–ª–µ `answer` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- –£–ª—É—á—à–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

**–ö–æ–¥:**
```python
# Extract answer from response (priority: answer field, then markdown, then text)
# The 'answer' field contains the final formatted answer from agent-result block
answer = response.get('answer')

# Fallback to markdown or text if answer is not present
if not answer:
    self.logger.warning("Agent did not return 'answer' field, using markdown/text as fallback")
    answer = response.get('markdown') or response.get('text', '')

if not answer:
    raise ValueError("Agent did not return an answer")

return answer
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç

–¢–µ–ø–µ—Ä—å —Ä–µ–∂–∏–º `/ask` —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

1. ‚úÖ **–ê–≥–µ–Ω—Ç –ø–æ–Ω–∏–º–∞–µ—Ç**, —á—Ç–æ –Ω—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç –≤ –ø–æ–ª–µ `answer`
2. ‚úÖ **–ü—Ä–æ–º–ø—Ç —è–≤–Ω–æ —Ç—Ä–µ–±—É–µ—Ç** –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
3. ‚úÖ **–ü–∞—Ä—Å–∏–Ω–≥ –∏–∑–≤–ª–µ–∫–∞–µ—Ç** –ø–æ–ª–µ `answer` –∏–∑ –±–ª–æ–∫–∞ `agent-result`
4. ‚úÖ **–ö–æ–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é** —Ç–æ–ª—å–∫–æ –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç, –∞ –Ω–µ –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–∏—Å–∫–∞
5. ‚úÖ **–ï—Å—Ç—å fallback** –Ω–∞ `markdown`/`text` –µ—Å–ª–∏ –∞–≥–µ–Ω—Ç –Ω–µ –≤–µ—Ä–Ω—É–ª `answer`

## –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã

1. `config/agent_prompts.py` - –æ–±–Ω–æ–≤–ª—ë–Ω –ø—Ä–æ–º–ø—Ç `KB_QUERY_PROMPT_TEMPLATE`
2. `src/agents/base_agent.py` - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `answer` –≤ `AgentResult` –∏ `parse_agent_response`
3. `src/agents/qwen_code_cli_agent.py` - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `answer` –≤ result
4. `src/services/question_answering_service.py` - —É–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
1. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –≤ —Ä–µ–∂–∏–º `/ask`
2. –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ –≤–∞—à–µ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ:
   - –û—Ç–≤–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
   - –û—Ç–≤–µ—Ç –ø–æ–Ω—è—Ç–Ω—ã–π –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
   - –ù–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–æ–∏—Å–∫–∞
   - –£–∫–∞–∑–∞–Ω—ã –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (—Ñ–∞–π–ª—ã –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π)

# Prompt Refactoring Summary

## Цель рефакторинга

Рефакторинг промптов агентов для обеспечения:
- **Версионности**: отслеживание изменений, откат к предыдущим версиям
- **Гибкости**: обновление промптов без изменения кода
- **Поддержки многоязычности**: английский и русский язык
- **Горячей перезагрузки**: обновление промптов без перезапуска
- **Удобства поддержки**: чёткая структура и документация

## Что было сделано

### 1. Создана структура директорий

```
config/
├── prompts/
│   ├── README.md                    # Документация по структуре
│   ├── v1/                          # Версия 1 (текущая)
│   │   ├── config.yaml              # Общая конфигурация
│   │   ├── qwen_code_agent.yaml     # Промпт для Qwen Code Agent (EN)
│   │   ├── qwen_code_cli_agent.yaml # Промпт для Qwen CLI Agent (RU)
│   │   ├── kb_query.yaml            # Промпт для запросов к БЗ (RU)
│   │   └── stub_agent.yaml          # Промпт для тестового агента
│   └── v2/                          # Версия 2 (зарезервирована)
│       └── README.md
├── prompt_loader.py                 # Класс загрузчика промптов
└── agent_prompts.py                 # Обратная совместимость
```

### 2. Реализован PromptLoader

Класс `PromptLoader` в `config/prompt_loader.py`:

**Основные возможности:**
- Загрузка промптов из YAML файлов
- Поддержка версий (v1, v2, ...)
- Кэширование для производительности
- Горячая перезагрузка
- Работа с шаблонами и их форматирование
- Доступ к конфигурации
- Singleton паттерн для глобального экземпляра

**Основные методы:**
- `get_instruction(agent_name)` - получить инструкцию агента
- `get_template(agent_name, template_name)` - получить шаблон
- `format_template(...)` - форматировать шаблон с переменными
- `get_config(key)` - получить значение конфигурации
- `get_category_keywords()` - получить ключевые слова категорий
- `reload()` - перезагрузить промпты из файлов
- `list_agents()` - список доступных агентов
- `list_versions()` - список доступных версий

### 3. Мигрированы все промпты в YAML

#### qwen_code_agent.yaml (EN)
- Инструкция для автономного агента (английский)
- Шаблоны: content_processing, urls_section
- Формат стандартизированного результата

#### qwen_code_cli_agent.yaml (RU)
- Инструкция для Qwen CLI агента (русский)
- Детальный процесс работы (9 шагов)
- Упор на русский язык во всех файлах
- Глубокий анализ и структурирование

#### kb_query.yaml (RU)
- Инструкция для запросов к базе знаний
- Поиск и ответы на вопросы пользователя
- Формат ответа с источниками

#### stub_agent.yaml (EN)
- Тестовый агент для разработки

#### config.yaml
- Ключевые слова категорий (ai, biology, physics, tech, business, science)
- Стоп-слова для извлечения ключевых слов
- Настройки генерации markdown
- Настройки безопасности инструментов

### 4. Обеспечена обратная совместимость

`config/agent_prompts.py` теперь:
- Помечен как DEPRECATED
- Использует PromptLoader внутри
- Предоставляет все старые константы через новый API
- Все старые константы работают без изменений

**Старый код продолжает работать:**
```python
from config.agent_prompts import (
    QWEN_CODE_CLI_AGENT_INSTRUCTION,
    CATEGORY_KEYWORDS,
    MAX_TITLE_LENGTH
)
```

### 5. Создана документация

#### PROMPT_REFACTORING_GUIDE.md
- Полное руководство по миграции
- Примеры использования
- Формат YAML файлов
- Best practices
- Troubleshooting

#### config/prompts/README.md
- Структура директорий
- История версий
- Инструкции по использованию
- Формат файлов

### 6. Созданы примеры и тесты

#### examples/prompt_loader_example.py
- Базовое использование
- Работа с шаблонами
- Доступ к конфигурации
- Версионирование
- Горячая перезагрузка
- Интеграция с агентами
- Обратная совместимость

#### tests/test_prompt_loader.py
- Тесты инициализации
- Тесты загрузки инструкций
- Тесты шаблонов
- Тесты конфигурации
- Тесты метаданных
- Тесты кэширования
- Тесты обратной совместимости
- Тесты обработки ошибок

## Использование

### Для нового кода (рекомендуется)

```python
from config.prompt_loader import PromptLoader

# Загрузить последнюю версию
loader = PromptLoader()

# Получить инструкцию
instruction = loader.get_instruction("qwen_code_cli_agent")

# Получить конфигурацию
categories = loader.get_category_keywords()
max_title = loader.get_config("markdown.max_title_length")

# Форматировать шаблон
prompt = loader.format_template(
    "qwen_code_agent",
    "content_processing",
    instruction=instruction,
    text="Контент для обработки",
    urls_section=""
)
```

### Для существующего кода (без изменений)

```python
from config.agent_prompts import (
    QWEN_CODE_CLI_AGENT_INSTRUCTION,
    CATEGORY_KEYWORDS,
    MAX_TITLE_LENGTH
)
# Всё работает как раньше!
```

### Работа с версиями

```python
# Загрузить конкретную версию
loader_v1 = PromptLoader(version="v1")

# Проверить версию
print(loader_v1.version)  # "v1"

# Получить метаданные
metadata = loader_v1.get_metadata("qwen_code_cli_agent")
print(metadata["version"])   # "1.0.0"
print(metadata["language"])  # "ru"
```

## Преимущества

### 1. Версионность
- История изменений в git
- A/B тестирование промптов
- Быстрый откат к предыдущей версии

### 2. Гибкость
- Обновление промптов без изменения кода
- Поддержка нескольких языков
- Легко добавлять новые промпты

### 3. Производительность
- Кэширование загруженных промптов
- Ленивая загрузка
- Singleton паттерн для глобального экземпляра

### 4. Разработка
- Горячая перезагрузка в development
- Чёткое разделение промптов и кода
- Легко тестировать разные промпты

### 5. Поддержка
- Понятная структура
- Документация в README
- Метаданные в YAML файлах

## Миграция

### Шаг 1: Обновить код (опционально)

Старый код продолжает работать, но для нового кода рекомендуется:

```python
# Было:
from config.agent_prompts import QWEN_CODE_CLI_AGENT_INSTRUCTION
instruction = QWEN_CODE_CLI_AGENT_INSTRUCTION

# Стало:
from config.prompt_loader import PromptLoader
loader = PromptLoader()
instruction = loader.get_instruction("qwen_code_cli_agent")
```

### Шаг 2: Обновить промпты в YAML (по необходимости)

1. Отредактировать YAML файл в `config/prompts/v1/`
2. Перезагрузить в development: `loader.reload()`
3. В production перезапустить приложение

### Шаг 3: Создать новую версию (для крупных изменений)

1. Скопировать `v1/` в `v2/`
2. Обновить версии в YAML файлах
3. Внести изменения
4. Тестировать: `loader = PromptLoader(version="v2")`
5. Обновить документацию

## Формат YAML

### Файл промпта агента

```yaml
version: "1.0.0"
name: "agent_name"
description: "Описание агента"
language: "ru"  # или "en"
created_at: "2025-10-07"

instruction: |
  Многострочная инструкция агента...
  Может содержать {placeholders} при необходимости.

templates:
  template_name: |
    Шаблон с {variable1} и {variable2}
  
  another_template: |
    Другой шаблон...
```

### Файл конфигурации

```yaml
version: "1.0.0"
description: "Описание конфигурации"

category_keywords:
  category_name:
    - keyword1
    - keyword2

markdown:
  max_title_length: 60
  max_summary_length: 200

tools:
  safe_git_commands:
    - status
    - log
```

## Тестирование

### Запустить тесты

```bash
pytest tests/test_prompt_loader.py -v
```

### Запустить примеры

```bash
python examples/prompt_loader_example.py
```

### Проверить обратную совместимость

```python
# Старый API должен работать
from config.agent_prompts import QWEN_CODE_CLI_AGENT_INSTRUCTION
assert len(QWEN_CODE_CLI_AGENT_INSTRUCTION) > 0
```

## Чек-лист выполненных задач

- [x] Создана структура `config/prompts/v1/`
- [x] Созданы YAML файлы для всех промптов агентов
- [x] Создан файл конфигурации `config.yaml`
- [x] Реализован класс `PromptLoader`
- [x] Обновлён `agent_prompts.py` для обратной совместимости
- [x] Создан файл примеров `examples/prompt_loader_example.py`
- [x] Созданы тесты `tests/test_prompt_loader.py`
- [x] Создано руководство `PROMPT_REFACTORING_GUIDE.md`
- [x] Создана документация `config/prompts/README.md`
- [x] Создан этот файл с общим резюме

## Дальнейшие улучшения

Возможные улучшения в будущем:

1. **Валидация промптов**
   - JSON Schema для YAML файлов
   - Автоматическая проверка формата

2. **Тестирование промптов**
   - Автоматическое тестирование промптов
   - Метрики качества промптов

3. **Динамический выбор**
   - Выбор промпта на основе контекста
   - A/B тестирование в runtime

4. **Наследование**
   - Базовые промпты и расширения
   - Переиспользование общих частей

5. **Внешние репозитории**
   - Загрузка промптов из внешних источников
   - Центральное хранилище промптов

## Заключение

Рефакторинг успешно выполнен! Теперь система промптов:

✅ Имеет версионность  
✅ Легко модифицируется  
✅ Поддерживает несколько языков  
✅ Позволяет горячую перезагрузку  
✅ Обратно совместима  
✅ Хорошо документирована  
✅ Покрыта тестами  

Все агенты продолжают работать без изменений, но теперь можно:
- Обновлять промпты без изменения кода
- Тестировать разные версии промптов
- Откатываться к предыдущим версиям
- Легко добавлять новые промпты

**Рекомендация:** Для нового кода используйте `PromptLoader` напрямую для максимальной гибкости.

# –°–≤–æ–¥–∫–∞: –ü–µ—Ä–µ–≤–æ–¥ –∞–≥–µ–Ω—Ç–æ–≤ –Ω–∞ mem-agent HTTP server

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ö–æ–≥–¥–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –≤–∫–ª—é—á–µ–Ω `AGENT_ENABLE_MCP_MEMORY=true`, –≤—Å–µ –∞–≥–µ–Ω—Ç—ã —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç **mem-agent HTTP server** –≤–º–µ—Å—Ç–æ stdio –≤–µ—Ä—Å–∏–∏. HTTP —Å–µ—Ä–≤–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Server-Sent Events (SSE) –¥–ª—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏, —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ª—É—á—à—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.

## –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. ‚úÖ MCPServerConfig (`src/agents/mcp/client.py`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `transport` –∏ `url` –≤ `MCPServerConfig`
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ "sse" (HTTP Server-Sent Events) —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞

**–ö–æ–¥:**
```python
@dataclass
class MCPServerConfig:
    """Configuration for an MCP server"""
    command: str
    args: List[str]
    env: Optional[Dict[str, str]] = None
    cwd: Optional[Path] = None
    transport: str = "stdio"  # "stdio" or "sse" (HTTP Server-Sent Events)
    url: Optional[str] = None  # URL for SSE transport (e.g., "http://127.0.0.1:8765/sse")
```

### 2. ‚úÖ MCPServerManager (`src/agents/mcp/server_manager.py`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- `setup_default_servers()` —Ç–µ–ø–µ—Ä—å –∑–∞–ø—É—Å–∫–∞–µ—Ç **mem_agent_server_http** –≤–º–µ—Å—Ç–æ mem_agent_server
- –°–µ—Ä–≤–µ—Ä —Å—Ç–∞—Ä—Ç—É–µ—Ç —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ `--host 127.0.0.1 --port 8765`
- –í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è `"transport": "http"`

**–ö–æ–¥:**
```python
config = {
    "name": "mem-agent",
    "description": "Agent's personal note-taking and search system",
    "command": "python",
    "args": ["-m", "src.agents.mcp.mem_agent_server_http", "--host", "127.0.0.1", "--port", "8765"],
    "env": {},
    "working_dir": str(Path.cwd()),
    "enabled": True,
    "transport": "http"
}
```

### 3. ‚úÖ MemoryAgentMCPTool (`src/agents/mcp/memory_agent_tool.py`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- `mcp_server_config` property —Ç–µ–ø–µ—Ä—å –ø–∞—Ä—Å–∏—Ç HTTP –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç URL –¥–ª—è SSE –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: `http://{host}:{port}/sse`
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `http://127.0.0.1:8765/sse`

**–õ–æ–≥–∏–∫–∞:**
1. –ß–∏—Ç–∞–µ—Ç `data/mcp_servers/mem-agent.json`
2. –ï—Å–ª–∏ `transport=http`, –ø–∞—Ä—Å–∏—Ç host –∏ port –∏–∑ args
3. –§–æ—Ä–º–∏—Ä—É–µ—Ç SSE URL
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç MCPServerConfig —Å transport="sse" –∏ url

### 4. ‚úÖ ToolManager (`src/agents/tools/registry.py`)

**–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è MCP memory tools –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ `enable_mcp_memory=True`
- –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ, –Ω–æ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç HTTP —Å–µ—Ä–≤–µ—Ä

### 5. ‚úÖ Settings (`config/settings.py`)

**–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
- `AGENT_ENABLE_MCP_MEMORY` –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å (default=False)
- –û–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ: "Enable MCP memory agent tool (local mem-agent via HTTP)"

### 6. ‚úÖ –í—Å–µ –∞–≥–µ–Ω—Ç—ã

**–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ª–æ–≥–∏–∫–µ:**
- AutonomousAgent - –ø–µ—Ä–µ–¥–∞–µ—Ç `enable_mcp_memory` –≤ `build_default_tool_manager`
- QwenCodeCLIAgent - –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç .qwen/settings.json –∫–æ–≥–¥–∞ `enable_mcp_memory=True`
- StubAgent - —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ MCP (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –°—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Agent Process  ‚îÇ
‚îÇ  (Python)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ –∫–æ–≥–¥–∞ AGENT_ENABLE_MCP_MEMORY=true
         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  MCPClient          ‚îÇ
‚îÇ  (Python SDK)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ HTTP SSE connection
         ‚îÇ http://127.0.0.1:8765/sse
         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  mem_agent_server_http       ‚îÇ
‚îÇ  (FastMCP HTTP/SSE server)   ‚îÇ
‚îÇ  Port: 8765                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ —Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –≤
         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  {kb_path}/memory/           ‚îÇ
‚îÇ  - processed.json            ‚îÇ
‚îÇ  - embeddings/               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**config.yaml:**
```yaml
# –í–∫–ª—é—á–∏—Ç—å MCP memory —á–µ—Ä–µ–∑ HTTP
AGENT_ENABLE_MCP_MEMORY: true
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
1. `main.py` —Å—Ç–∞—Ä—Ç—É–µ—Ç `MCPServerManager.auto_start_servers()`
2. `MCPServerManager` –∑–∞–ø—É—Å–∫–∞–µ—Ç `mem_agent_server_http` –Ω–∞ –ø–æ—Ä—Ç—É 8765
3. –ê–≥–µ–Ω—Ç—ã –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è –∫ `http://127.0.0.1:8765/sse` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è/–ø–æ–∏—Å–∫–∞ –ø–∞–º—è—Ç–∏
4. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `{kb_path}/memory/`

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ HTTP —Å–µ—Ä–≤–µ—Ä–∞

‚úÖ **–õ—É—á—à–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç stdio streams  
‚úÖ **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π** - –æ–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä –¥–ª—è –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤  
‚úÖ **–ü—Ä–æ—â–µ –æ—Ç–ª–∞–¥–∫–∞** - –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å curl/Postman  
‚úÖ **–°—Ç–∞–±–∏–ª—å–Ω–µ–µ** - –º–µ–Ω—å—à–µ –ø—Ä–æ–±–ª–µ–º —Å –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–µ–π –∏ encoding  
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤  

## –ú–∏–≥—Ä–∞—Ü–∏—è —Å stdio –Ω–∞ HTTP

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è!**

–ü—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ:
```yaml
AGENT_ENABLE_MCP_MEMORY: true
```

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –°–æ–∑–¥–∞—Å—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ `data/mcp_servers/mem-agent.json`
2. –ó–∞–ø—É—Å—Ç–∏—Ç HTTP —Å–µ—Ä–≤–µ—Ä –≤–º–µ—Å—Ç–æ stdio
3. –ü–æ–¥–∫–ª—é—á–∏—Ç –≤—Å–µ –∞–≥–µ–Ω—Ç—ã –∫ HTTP —Å–µ—Ä–≤–µ—Ä—É

**–î–∞–Ω–Ω—ã–µ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã!** –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ—Ç –∂–µ `{kb_path}/memory/processed.json`

## –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞  
‚úÖ –ï—Å–ª–∏ `AGENT_ENABLE_MCP_MEMORY=false`, MCP memory –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ–æ–±—â–µ  
‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ `{kb_path}/memory/` —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π  
‚úÖ –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É stdio –∏ HTTP –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö  

## –§–∞–π–ª—ã, –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ

1. `src/agents/mcp/client.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ SSE transport –≤ MCPServerConfig
2. `src/agents/mcp/memory_agent_tool.py` - –ø–∞—Ä—Å–∏–Ω–≥ HTTP –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
3. `src/agents/mcp/server_manager.py` - –∑–∞–ø—É—Å–∫ mem_agent_server_http
4. `config/settings.py` - –æ–±–Ω–æ–≤–ª–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ AGENT_ENABLE_MCP_MEMORY

**–§–∞–π–ª—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ):**
- `src/agents/autonomous_agent.py`
- `src/agents/qwen_code_cli_agent.py`
- `src/agents/stub_agent.py`
- `src/agents/agent_factory.py`
- `src/agents/tools/registry.py`
- `tests/test_stub_agent.py`
- `tests/test_agent_factory.py`

## –ü—Ä–æ–≤–µ—Ä–∫–∞

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–Ω—Ç–µ—Ä
No linter errors found ‚úÖ

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å HTTP —Å–µ—Ä–≤–µ—Ä –≤—Ä—É—á–Ω—É—é (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
python -m src.agents.mcp.mem_agent_server_http --host 127.0.0.1 --port 8765

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
curl http://127.0.0.1:8765/sse

# 4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∞–≥–µ–Ω—Ç–µ
AGENT_ENABLE_MCP_MEMORY=true python main.py
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
2. ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
3. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
4. üîÑ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö

---

**–î–∞—Ç–∞:** 2025-10-08  
**–ê–≤—Ç–æ—Ä:** Background Agent (Cursor)  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
